<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Style Conversion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="cartoon.css">
</head>

<body>
    <header class="main-header">
        <h1>Animation Style Conversion</h1>
    </header>

    <div id="container">
        <div class="side" id="leftSide">
            <h4>Uploadする画像</h4>
            <img id="uploadedImage" src="" alt="Uploaded Image">
        </div>
        <div class="side" id="rightSide">
            <h4>Animation画像</h4>
            <img id="animatedImage" src="" alt="Animated Image">
        </div>
    </div>

    <div id="processingMessage" class="centered-elements">
        <h4 id="processingText">Processing...</h4>
    </div>

    <div class="centered-elements action-area">
        <input type="file" id="fileInput" class="file-input">
        <button onclick="convertToAnimation()" class="action-button">Animationに変換</button>
        <button id="downloadButton" class="action-button" style="display: none;">画像をダウンロード</button>
    </div>

    <div class="centered-elements">
        <a href="http://neilaeden.com" class="link">トップページに戻る</a>
    </div>

    <div class="design-section">
        <h2>Design</h2>
        <img src="system7.png" alt="SystemDesign">
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadedImage = document.getElementById('uploadedImage');
        const processingMessage = document.getElementById('processingMessage');
        const processingText = document.getElementById('processingText');
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.addEventListener('click', function () {
            const link = document.createElement('a');
            link.href = animatedImage.src;
            link.download = 'animation_image.png';
            link.click();
        });

        let colorIndex = 0;
        const colors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
        function changeColor() {
            processingText.style.color = colors[colorIndex];
            colorIndex = (colorIndex + 1) % colors.length;
        }

        let colorInterval;

        fileInput.addEventListener('change', function () {
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                uploadedImage.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                uploadedImage.src = "";
            }
        });

        function convertToAnimation() {
            const animatedImage = document.getElementById('animatedImage');
            const file = fileInput.files[0]

            processingMessage.style.display = 'block';
            processingText.style.display = 'block';

            colorInterval = setInterval(changeColor, 500);

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function () {
                const base64data = reader.result.split(',')[1];
                const dataToSend = JSON.stringify({
                    base64Image: base64data
                });

                fetch('https://lzeeniah1j.execute-api.ap-northeast-1.amazonaws.com/convert', {
                    method: 'POST',
                    headers: {
                        'APIKEY': 'HLUBr4h9aSdgCKQIOVCPLkTc84prl9hwGbXuIzJDRnxyYN76KjVUiAPuo51As5JE',
                        'Content-Type': 'application/json'
                    },
                    body: dataToSend
                })
                    .then(response => {
                        clearInterval(colorInterval);
                        if (!response.ok) {
                            return response.json().then(data => { throw new Error(data.error) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.base64Image) {
                            animatedImage.src = "data:image/png;base64," + data.base64Image;
                            processingText.innerText = "Done";
                            downloadButton.style.display = 'block';
                        } else {
                            console.error('base64ImageプロパティがAPIのレスポンスに存在しません');
                        }
                        processingMessage.style.display = 'none';
                    })
                    .catch(error => {
                        clearInterval(colorInterval);
                        console.error('Error:', error);
                        processingText.innerText = "Error";
                        alert('エラーが発生しました: ' + error.message);

                        processingMessage.style.display = 'none';
                    });
            }
        }
    </script>
    <footer class="main-footer">
        <p>© 2023 Animation Converter. All rights reserved.</p>
    </footer>
</body>

</html>